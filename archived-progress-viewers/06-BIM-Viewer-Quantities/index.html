<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BIM Model Viewer</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Loading Overlay (init only) -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Initializing IFC engine...</div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
</div>

<!-- Model Loading Toast (non-blocking, shown during file loads) -->
<div class="load-toast" id="loadToast">
  <div class="load-toast-header">
    <div class="load-toast-spinner"></div>
    <div class="load-toast-title" id="loadToastTitle">Loading models...</div>
    <div class="load-toast-timer" id="loadToastTimer">0s</div>
  </div>
  <div class="load-toast-progress">
    <div class="load-toast-progress-fill" id="loadToastProgressFill"></div>
  </div>
  <div class="load-toast-step" id="loadToastStep">Preparing...</div>
  <div class="load-toast-queue" id="loadToastQueue"></div>
</div>

<!-- Drop Zone -->
<div class="drop-zone" id="dropZone">
  <div class="drop-zone-content">
    <h2>Drop IFC Files</h2>
    <p>Release to load your .ifc models</p>
  </div>
</div>

<!-- Hidden File Input (multiple) -->
<input type="file" id="fileInput" accept=".ifc" multiple style="display:none">

<!-- App Layout -->
<div class="app">

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="header">
      <h1 id="modelTitle">BIM Model Viewer</h1>
      <div class="subtitle" id="modelSubtitle">Load IFC files to begin</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="tree">Spatial</div>
      <div class="tab" data-tab="uniformat">UniFormat</div>
      <div class="tab" data-tab="elements">Elements</div>
      <div class="tab" data-tab="quantities">Quantities</div>
      <div class="tab" data-tab="models">Models</div>
    </div>

    <!-- SPATIAL TREE PANEL -->
    <div class="panel active" id="panel-tree">
      <div id="welcomePanel" class="welcome">
        <h2>BIM Model Viewer</h2>
        <p>Load any IFC models to explore the spatial structure, inspect element properties, and navigate your building model — all in the browser.</p>
        <button class="browse-btn" id="browseBtn">Browse for IFC Files</button>
        <div class="or-text">or</div>
        <div class="drop-hint">Drag &amp; drop .ifc files anywhere</div>
      </div>
      <div id="treeContent" class="hidden">
        <div class="filter-bar">
          <select id="filterStorey"><option value="all">All Levels</option></select>
          <select id="filterType"><option value="all">All Types</option></select>
        </div>
        <div id="spatialTree"></div>
      </div>
    </div>

    <!-- UNIFORMAT PANEL -->
    <div class="panel" id="panel-uniformat">
      <div class="uf-toolbar">
        <div class="uf-toolbar-row">
          <input type="text" id="ufSearch" class="uf-search" placeholder="Search by code, name, or type...">
        </div>
        <div class="uf-toolbar-row">
          <button class="btn-sm btn-secondary" id="ufReclassifyBtn" title="Re-run auto-classification">
            <span class="icon">⚙</span> Re-classify
          </button>
          <button class="btn-sm btn-secondary" id="ufResetViewBtn" title="Reset 3D visibility">
            <span class="icon">↺</span> Reset View
          </button>
          <button class="btn-sm btn-secondary" id="ufExportBtn" title="Export classifications to CSV">
            <span class="icon">↓</span> Export CSV
          </button>
        </div>
        <div class="uf-toolbar-row">
          <button class="btn-sm btn-secondary" id="ufSaveOverridesBtn" title="Export manual overrides to JSON file">
            <span class="icon">&#128190;</span> Save Overrides
          </button>
          <button class="btn-sm btn-secondary" id="ufLoadOverridesBtn" title="Import manual overrides from JSON file">
            <span class="icon">&#128194;</span> Load Overrides
          </button>
          <span class="uf-save-status" id="ufSaveStatus"></span>
        </div>
      </div>
      <div class="uf-legend">
        <span class="uf-legend-item"><span class="uf-src-icon src-prop">◆</span> IFC Data</span>
        <span class="uf-legend-item"><span class="uf-src-icon src-auto">⚙</span> Auto-mapped</span>
        <span class="uf-legend-item"><span class="uf-src-icon src-manual">✎</span> Manual</span>
        <span class="uf-legend-tip">Click group to select · Double-click to isolate · Right-click to reassign</span>
      </div>
      <div id="uniformatTree"></div>
    </div>

    <!-- ELEMENTS PANEL -->
    <div class="panel" id="panel-elements">
      <div class="search-box">
        <input type="text" id="elementSearch" placeholder="Search elements by name, type, or level...">
      </div>
      <div id="elementsList"></div>
    </div>

    <!-- QUANTITIES PANEL -->
    <div class="panel" id="panel-quantities">
      <div class="qt-toolbar">
        <div class="qt-toolbar-row">
          <div class="qt-mode-toggle">
            <button class="qt-mode-btn active" id="qtModeSpatial">Spatial</button>
            <button class="qt-mode-btn" id="qtModeUniformat">UniFormat</button>
          </div>
        </div>
        <div class="qt-toolbar-row">
          <input type="text" id="qtSearch" class="qt-search" placeholder="Search storeys, types, or codes...">
        </div>
        <div class="qt-toolbar-row">
          <button class="btn-sm btn-secondary" id="qtExportBtn" title="Export quantities to CSV">
            <span class="icon">↓</span> Export CSV
          </button>
        </div>
      </div>
      <div id="qtTree"></div>
    </div>

    <!-- MODELS PANEL -->
    <div class="panel" id="panel-models">
      <div class="models-toolbar">
        <button class="btn-primary btn-sm" id="btnAppendModels">
          <span class="icon">+</span> Append Models
        </button>
        <button class="btn-danger-sm" id="btnClearAll">
          <span class="icon">&times;</span> Clear All
        </button>
      </div>
      <div id="modelsList" class="models-list">
        <div class="models-empty" id="modelsEmpty">No models loaded. Use the Browse button or drag &amp; drop IFC files to load.</div>
      </div>
    </div>
  </div>

  <!-- 3D Viewer -->
  <div class="viewer">
    <div id="canvas-container"></div>

    <div class="viewer-overlay">
      <div class="viewer-info" id="viewerInfo">No model loaded</div>
      <div class="viewer-tools">
        <button class="viewer-btn" id="btnResetView" title="Reset view (Esc)">
          <span class="icon">&#8634;</span> Reset
        </button>
        <button class="viewer-btn" id="btnRotateModel" title="Cycle axis orientation (R)">
          <span class="icon">&#10227;</span> Axis
        </button>
        <button class="viewer-btn" id="btnWireframe" title="Toggle wireframe (W)">
          <span class="icon">&#9638;</span> Wire
        </button>
        <button class="viewer-btn" id="btnXray" title="Toggle x-ray (X)">
          <span class="icon">&#9671;</span> X-Ray
        </button>
        <button class="viewer-btn" id="btnSectionCut" title="Section cut (C)">
          <span class="icon">&#9986;</span> Section
        </button>
        <button class="viewer-btn" id="btnPropsPanel" title="Toggle properties panel (P)">
          <span class="icon">&#9776;</span> Props
        </button>
        <button class="viewer-btn" id="btnClearSelection" title="Clear selection (Q)">
          <span class="icon">&#10005;</span> Clear
        </button>
        <span class="toolbar-sep"></span>
        <button class="viewer-btn" id="btnIsolateSelection" title="Isolate selection — show only selected (I)">
          <span class="icon">&#9673;</span> Isolate
        </button>
        <button class="viewer-btn" id="btnHideSelection" title="Hide selection (H)">
          <span class="icon">&#9676;</span> Hide
        </button>
        <button class="viewer-btn" id="btnShowAll" title="Show all elements (A)">
          <span class="icon">&#9788;</span> Show All
        </button>
      </div>
    </div>

    <div class="selection-info" id="selectionInfo">
      <h3 id="selName"></h3>
      <div class="sel-meta" id="selMeta"></div>
    </div>

    <!-- Floating Properties Panel -->
    <div class="props-panel" id="propsPanel">
      <div class="props-panel-header">
        <div class="props-panel-title">Properties</div>
        <button class="props-panel-close" id="propsPanelClose">&times;</button>
      </div>
      <div class="props-panel-body">
        <div id="detailPlaceholder" class="props-panel-placeholder">
          Select an element to view its properties.
        </div>
        <div id="detailContent" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Import Map for ES modules (CDN, no build step) -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<!-- web-ifc WASM engine -->
<script src="https://unpkg.com/web-ifc@0.0.66/web-ifc-api-iife.js"></script>

<!-- Viewer module -->
<script type="module" src="viewer.js"></script>

<!-- Section Cut tool -->
<script type="module">
  import { toggle } from './section-cut.js';
  document.getElementById('btnSectionCut').addEventListener('click', toggle);
</script>

<!-- Quantification tool -->
<script type="module">
  import { initQuantificationPanel, wireQuantificationEvents } from './quantification.js';

  wireQuantificationEvents();

  window.addEventListener('quantification-refresh', () => {
    initQuantificationPanel();
  });
</script>

<!-- UniFormat Classification tool -->
<script type="module">
  import { initUniformatPanel, wireUniformatSearch } from './uniformat.js';

  // Wire search and toolbar buttons immediately
  wireUniformatSearch();

  // Listen for model load events to trigger classification
  // The viewer dispatches 'uniformat-refresh' after models are loaded
  window.addEventListener('uniformat-refresh', () => {
    initUniformatPanel();
  });
</script>

</body>
</html>
